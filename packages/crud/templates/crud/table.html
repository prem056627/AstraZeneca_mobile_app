{% extends 'frame/_base.html' %}
{% load crispy_forms_tags %}
{% load zstatic %} 

{% block head %}
    <title>{{page_title}}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Source+Code+Pro:wght@400;600;700&display=swap"
        rel="stylesheet" />


    <link rel="stylesheet" href="{% zstatic 'packages/crud/css/index.css' %}">

    <script src="{% zstatic 'packages/crud/js/jquery/jquery-3.7.1.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/bootstrap/5.3.0/bootstrap.bundle.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/pdfmake/0.2.7/pdfmake.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/pdfmake/0.2.7/vfs_fonts.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/jquery-datatable/sr-1.3.0/datatable.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/jquery-datatable/plugins/pagination-1.13.6/input.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/jquery-datatable/plugins/fixedcolumns-4.3.0/dataTables.fixedColumns.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/popperjs/2.11.8/popper.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/select2/4.1.0/select2.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/tinycolor/1.6.0/tinycolor.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/moment/2.18.1/moment.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/daterangepicker/3.14.1/daterangepicker.min.js' %}"></script>
    <script src="{% zstatic 'packages/crud/js/jquery-toast/1.3.2/jquery.toast.min.js' %}"></script>

    {% comment %} <script src="{% zstatic 'packages/crud/js/dynamic-form/dynamicForm.js' %}"></script> {% endcomment %}


    <link rel="stylesheet" href="{% zstatic 'packages/crud/css/style.css' %}">
    <link rel="stylesheet" href="{% zstatic 'packages/crud/css/table.css' %}">
    
    <!-- TODO: handle custom css -->
    {% block custom_css %}
   
    {% endblock %}

{% endblock %}

{% block page_content %}


<form method="post">
    {% csrf_token %}
</form>
<div class="page-title-bar">
    <div>
        <h2 class="page-title"></h2>
    </div>
    {% if has_add_perm %}
        <div>     
            <button type="button" class="page-add-button">
                <span class="page-add-button-label">
                    {{add_btn_title}}
                </span>
                <div class="page-add-button-icon">

                </div>
            </button>
        </div>
    {% endif %}
</div>
<div class="overlay-spinner" style="display: none;"></div>

<div id="offcanvas-container" tabindex="-1">
</div>


<div id="row_actions_form_modal" class="modal-overlay"  style="display:none;">
    <div class="modal-content">
        <button type="button" data-modal="row_actions_form_modal" class="modal-close">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>
        </button>
        <div id="zelthy-dynamic-form" class="zelthy-dynamic-form" style="height: 100%;"></div>
    </div>
</div>

<div class="row-action-simple-dialog-overlay">
    <div class="row-action-simple-dialog">
        <form class="row-action-simple-dialog-form">
            <div class="row-action-simple-dialog-content">
                <h4 class="row-action-simple-dialog-title"></h4>
                <p class="row-action-simple-dialog-description">
                </p>
            </div>
            <div class="row-action-simple-dialog-ctas">
                <button type="button" class="secondary-button close-button">Cancel</button>
                <button type="submit" class="primary-button">Confirm</button>
            </div>
        </form>
    </div>
</div>

<div class="table-outer-box" style="height: 100%;">
    <!-- TODO: Handle styling  -->
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        {% block table-top %} {% endblock %} 
    </div>
    <table id="zangotable" class="stripe hover order-column" style="width: 100%">
    </table>

    <div style="width: calc(100%) !important; height: calc(100%); bottom: 0; right: 0; position: absolute; z-index: 5;" class="offcanvas offcanvas-end" data-bs-backdrop="false" tabindex="-1" id="offcanvasDetailsIframe" aria-labelledby="offcanvasDetailsIframeLabel">
        <button type="button" style="position: absolute; top: 8px; right: 8px;" class="btn-close" id="detailViewIframeClose" data-bs-dismiss="offcanvas" aria-label="Close">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>
        </button>
        <div class="offcanvas-body" style="padding: 0;">
           <iframe id="detailViewIframe" frameBorder="0" tabindex="-1" src="" style="width: 100%; height: 100%; border: none; outline: none; border:none;"></iframe>
        </div>
    </div>

    

    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasBottom" aria-labelledby="offcanvasBottomLabel">
        <div class="drawer-handle-wrapper"><div class="drawer-handle"></div></div>
        <!-- <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvasBottomLabel">Details View</h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div> -->
        <div class="details-offcanvas-body">
      

          
        </div>
      </div>
     <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        {% block table-bottom %} {% endblock %}
      </div>
</div>


<script>
    var csrf_token = "{{ csrf_token }}";
    let table_metadata = {{table_metadata| safe}};
    const config = {...{{ frame_config| safe}}};
    const app_theme_config = {{ app_theme_config| safe}};
    const pageTitle = "{{page_title|safe}}";
    var has_export_permission = "{{has_export_perm|safe}}"
    let drawer_width = {
        "drawer-half": "50%",
        "drawer-two-third": "75%",
        "drawer-full": "100%"
    }
    let forms_metadata = {{forms_metadata| safe}};
    if (typeof URLParams === 'undefined') {
        var URLParams = "";
    }
</script>
{% block custom_js_before_base_script %} {% endblock %}
<script src="{% zstatic 'packages/crud/js/table/table.js' %}"> </script>
<script type="text/javascript">
    $(".page-title").html(pageTitle);

    const iframe = document.getElementById('detailViewIframe');

    iframe.addEventListener('load', (event) => {
        if (event.target.src === window.location.href) {
            console.log("found iframe");
            event.preventDefault();
        }
    });

    window.addEventListener('popstate', function(event) {
    console.log('Back button pressed');
    // Your code here to handle the back button press
    });


    async function renderDynamicForm(formContainerId, offcanvasId, buttonId, config, layout) {
        try {
            // Create the offcanvas HTML structure
            const offcanvasHtml = `
                <div class="offcanvas offcanvas-end"tabindex="-1" id="${offcanvasId}" style="width: ${drawer_width[layout.layout]};" aria-labelledby="${offcanvasId}Label">
                    <div class="offcanvas-content">
                        <button type="button" data-bs-dismiss="offcanvas" id="${offcanvasId}-close" aria-label="Close" class="modal-close">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <g clip-path="url(#clip0_5158_6104)">
                                    <path d="M17.7213 1.22117L10.5168 8.42571C10.2219 8.72061 9.75409 8.72061 9.48417 8.42571L2.27865 1.22117C1.98375 0.926275 1.51593 0.926275 1.24601 1.22117C0.951112 1.51607 0.951112 1.9839 1.24601 2.25382L8.45153 9.45933C8.74643 9.75423 8.74643 10.2221 8.45153 10.492L1.22117 17.7213C0.926275 18.0162 0.926275 18.4841 1.22117 18.754C1.51607 19.0489 1.9839 19.0489 2.25382 18.754L9.45933 11.5485C9.75423 11.2536 10.2221 11.2536 10.492 11.5485L17.7213 18.7788C18.0162 19.0737 18.4841 19.0737 18.754 18.7788C19.0489 18.4839 19.0489 18.0161 18.754 17.7462L11.5736 10.5158C11.2787 10.2209 11.2787 9.7531 11.5736 9.48319L18.7791 2.27767C19.074 1.98277 19.074 1.51494 18.7791 1.24503C18.4842 0.950129 18.0173 0.950129 17.7214 1.22101L17.7213 1.22117Z" fill="black" stroke="black" stroke-width="0.4"/>
                                </g>
                                <defs>
                                    <clipPath id="clip0_5158_6104">
                                        <rect width="20" height="20" fill="white"/>
                                    </clipPath>
                                </defs>
                            </svg>
                        </button>
                        <div id="${formContainerId}" class="zelthy-dynamic-form" style="height: 100%; width: 100%;"></div>
                    </div>
                </div>
            `;

            // Append the offcanvas HTML to the body
            $("body").append(offcanvasHtml);
            $(`.${buttonId}`).css("opacity", 1);

            // Attach the click event to the button to open the offcanvas
            $(`.${buttonId}`).on("click", function () {
                console.log(`${buttonId} clicked`);
                $(`#${offcanvasId} #${formContainerId}`).attr(
                    "data-config",
                    JSON.stringify(config)
                );
                var offcanvasElement = document.getElementById(offcanvasId);
                var offcanvasInstance = new bootstrap.Offcanvas(offcanvasElement);
                offcanvasInstance.show(); // Manually trigger the offcanvas to open
            });

            $(`#${offcanvasId}-close`).on("click", function () {
                $(`#${offcanvasId} #${formContainerId}`).attr("data-config", "");
            });

        } catch (error) {
            console.error("Error fetching the width for the offcanvas:", error);
        }
    }

    // Example usage
    renderDynamicForm(
        'zelthy-dynamic-form',
        'page_add_modal',
        'page-add-button',
        {
            get_data: {
                is_api_based: true,
                url: "./?action=initialize_form",
                static_config: {},
            },
            post_data: {
                http_method: "POST",
                url: "./?form_type=create_form",
                payload_type: "FORMDATA",
            },
        },
        forms_metadata.create_form
    );


</script>
{% block load_zform_lib %}
 <script src="{% zstatic 'packages/crud/js/zform_lib.v2.0.0.min.js' %}"></script>

{% endblock %}


<!-- TODO: Handle -->
{% block custom_js_after_base_script %} {% endblock %}


{% endblock %}


