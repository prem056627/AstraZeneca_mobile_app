let newAppConfig = { ...config, config: newAppThemeConfig };
let draftDrawerOpen = false;

const root = document.querySelector(":root");
const setCssVariables = (vars) =>
  Object.entries(vars).forEach((v) => root.style.setProperty(v[0], v[1]));
const crudCssVariables = {
  "--primary-color":
    tinycolor
      .mix(
        tinycolor(newAppConfig?.config?.color?.primary).toHexString(),
        "#FFFFFF",
        9
      )
      .toHexString() || "#DDE2E5",
  "--secondary-color":
    tinycolor(newAppConfig?.config?.color?.secondary).toHexString() ||
    "#E1D6AE",
  "--accent-color":
    tinycolor(newAppConfig?.config?.color?.accent).toHexString() || "#DDE2E5",
  "--background-color":
    tinycolor(newAppConfig?.config?.color?.background).toHexString() ||
    "#FFFFFF",
  "--typography-color":
    tinycolor(newAppConfig?.config?.color?.typography).toHexString() ||
    "#212429",
  "--top-navbar-color": tinycolor(newAppConfig?.config?.color?.header).isLight()
    ? tinycolor(newAppConfig?.config?.color?.typography).toHexString() ||
      "#212429"
    : "#FFFFFF",
  "--top-navbar-background-color":
    tinycolor(newAppConfig?.config?.color?.header).toHexString() || "#FFFFFF",
  "--top-navbar-border-color":
    tinycolor(newAppConfig?.config?.color?.headerBorder).toHexString() ||
    "#DDE2E5",
  "--side-navbar-color": tinycolor(
    newAppConfig?.config?.color?.sidebar
  ).isLight()
    ? tinycolor(newAppConfig?.config?.color?.typography).toHexString() ||
      "#212429"
    : "#FFFFFF",
  "--side-navbar-background-color":
    tinycolor(newAppConfig?.config?.color?.sidebar).toHexString() || "#E1D6AE",
  "--side-navbar-hover-background-color": tinycolor(
    newAppConfig?.config?.color?.sidebar
  ).isLight()
    ? tinycolor
        .mix(
          tinycolor(newAppConfig?.config?.color?.sidebar).toHexString(),
          "#000000",
          6
        )
        .toHexString() || "#E1D6AE"
    : tinycolor
        .mix(
          tinycolor(newAppConfig?.config?.color?.sidebar).toHexString(),
          "#FFFFFF",
          6
        )
        .toHexString() || "#FFFFFF",
};
setCssVariables(crudCssVariables);

var inputElements = document.getElementsByName("csrfmiddlewaretoken");
//   let csrf_token = inputElements[0].value;

$(document)
  .find(".com-pkg-menu-item")
  .on("click", function () {
    // Remove the 'active' class from all menu items and tab contents
    $(".com-pkg-menu-item").removeClass("active");
    $(".com-pkg-tab-content").removeClass("active");

    $(".com-pkg-tab-item").removeClass("active");
    $(".com-pkg-individual-tab-content").removeClass("active");

    $("#com-pkg-email-tab .com-pkg-tab-item:first").addClass("active");
    $("#com-pkg-email-tab .com-pkg-individual-tab-content:first").addClass(
      "active"
    );

    // Add the 'active' class to the clicked menu item
    $(this).addClass("active");

    // Get the associated tab ID from the 'data-tab' attribute
    var tabId = $(this).data("tab");

    // Add the 'active' class to the corresponding tab content
    $("#" + tabId).addClass("active");
  });

$(document)
  .find(".com-pkg-tab-item")
  .on("click", function () {
    // Remove the 'active' class from all menu items and tab contents
    $(".com-pkg-tab-item").removeClass("active");
    $(".com-pkg-individual-tab-content").removeClass("active");

    // Add the 'active' class to the clicked menu item
    $(this).addClass("active");

    // Get the associated tab ID from the 'data-tab' attribute
    var tabId = $(this).data("tab");

    if (tabId === "com-pkg-email-received") {
      emailReceivedTable.ajax.reload();
    }

    if (tabId === "com-pkg-email-sent") {
      emailSentTable.ajax.reload();
    }

    if (tabId === "com-pkg-email-drafts") {
      emailDraftTable.ajax.reload();
    }

    console.log("tabId", tabId);

    // Add the 'active' class to the corresponding tab content
    $("#" + tabId).addClass("active");
  });

function ZToast(type, title, message, duration) {
  $.toast({
    text: `<div class="z-toast-node ${{ error: "z-toast-error", success: "z-toast-success", warning: "z-toast-warning" }[type]}">
                    <h3 class="title">
                        ${title}
                    </h3>
                    <span class="message">
                        ${message}
                    </span>
                </div>`,
    hideAfter: duration,
  });

  $(document).find(".jq-toast-single").find(".close-jq-toast-single")
    .html(`<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Icon/Navigation/16px/Close" clip-path="url(#clip0_1917_1245)">
                <path id="Vector" d="M10.5041 0.879019L6.30147 5.08166C6.12945 5.25369 5.85655 5.25369 5.6991 5.08166L1.49588 0.879019C1.32386 0.706994 1.05096 0.706994 0.893507 0.879019C0.721482 1.05104 0.721482 1.32394 0.893507 1.48139L5.09673 5.68461C5.26875 5.85664 5.26875 6.12953 5.09673 6.28699L0.879019 10.5041C0.706994 10.6761 0.706994 10.949 0.879019 11.1065C1.05104 11.2785 1.32394 11.2785 1.48139 11.1065L5.68461 6.90327C5.85664 6.73125 6.12954 6.73125 6.28699 6.90327L10.5041 11.121C10.6761 11.293 10.949 11.293 11.1065 11.121C11.2785 10.949 11.2785 10.6761 11.1065 10.5186L6.91791 6.3009C6.74588 6.12887 6.74588 5.85598 6.91791 5.69853L11.1211 1.49531C11.2932 1.32328 11.2932 1.05038 11.1211 0.892933C10.9491 0.720908 10.6768 0.720908 10.5042 0.878924L10.5041 0.879019Z" fill="#6C747D" stroke="#6C747D" stroke-width="0.4"/>
                </g>
                <defs>
                <clipPath id="clip0_1917_1245">
                <rect width="12" height="12" fill="white"/>
                </clipPath>
                </defs>
                </svg>
            `);
}

let opendDraftMail;
let attatchmentsList;
let baseUrl = window.location.origin + "/communication/dashboard";

if (document.getElementById("com-pkg-compose-email-body")) {
  var quill = new Quill("#com-pkg-compose-email-body", {
    theme: "snow",
    placeholder: "Enter email body",
  });

  quill.enable();
}

let emailErrorType;
function validateForm() {
  // Simple validation example (add more checks as needed)
  var subject = $("#com-pkg-compose-email-subject").val();
  var email = $("#com-pkg-compose-email-to").val();
  var ccEmails = $("#com-pkg-compose-email-cc").val();

  if (subject?.trim() === "") {
    alert("subject it empty");
  }

  if (email?.trim() === "" || !isValidEmail(email)) {
    emailErrorType = "email";
    return false;
  }

  if (ccEmails?.trim() !== "" && !validateEmails(ccEmails)) {
    emailErrorType = "ccEmails";
    return false;
  }

  return true;
}

function isValidEmail(email) {
  // Basic email validation (you may want to use a more robust method)
  var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validateEmails(emails) {
  const emailArray = emails.split(",").map((email) => email.trim());
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  return emailArray.every((email) => emailRegex.test(email));
}

// handle email detali view here
const emailDetailViewModal = document.getElementById("email-detail-view-modal");
var emailOffcanvas = new bootstrap.Offcanvas(emailDetailViewModal);
function handleEmailDetailView(data) {
  console.log("print detail view data", data);
  emailOffcanvas.show();

  $("#com-dash-detail-view-heading").html(data.subject);
  $("#com-dash-detail-view-from").html(data.from_email);

  if (data.cc_email.length > 0) {
    $("#com-dash-detail-view-date").html(
      data.cc_email.map((el) => el).join(",")
    );
    $("#com-pkg-email-received-cc").css("display", "block");
  }
  if (data.attachments.length > 0) {
    $("#com-pkg-attachment-label").html(
      `${data.attachments.length} attachment(s)`
    );
    $("#com-pkg-attachment-label").css("display", "block");
  }

  if (data.timestamp.length > 0) {
    $("#com-dash-detail-view-date").html(data.timestamp);
    $("#com-dash-detail-view-date").css("display", "block");
  }

  let ccElement = data.cc_email
    .map((el) => {
      return `
                    <div class="com-pkg-email-details-label">CC: ${el}</div>
                    `;
    })
    .join("");

  console.log("data.cc_email", ccElement);
  let attachmentElement = data.attachments
    .map((el) => {
      return `<div class="email-attachment-click" data-attachment=${JSON.stringify(el)} style="padding-left: 12px; padding-right: 12px; padding-top: 8px; padding-bottom: 8px; 
            border-radius: 6px; border: 1px #DDE2E5 solid; flex-direction: column; justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex; cursor: pointer;" id="com-pkg-email-attachment">
                        <div style="justify-content: flex-start; align-items: flex-start; gap: 12px; display: inline-flex">
                            <div style="width: 18px; height: 18px; position: relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                    <path d="M4.44011 4.91994C2.18824 4.91994 0.360107 6.74807 0.360107 8.99994C0.360107 11.2518 2.18824 13.0799 4.44011 13.0799H13.5601C13.6885 13.0818 13.8123 13.0321 13.9042 12.9421C13.9951 12.8512 14.0467 12.7284 14.0467 12.5999C14.0467 12.4715 13.9951 12.3487 13.9042 12.2577C13.8123 12.1677 13.6885 12.1181 13.5601 12.1199H4.44011C2.70292 12.1199 1.32011 10.7371 1.32011 8.99993C1.32011 7.26274 2.70292 5.87993 4.44011 5.87993H14.6401C15.7782 5.87993 16.6801 6.7818 16.6801 7.91993C16.6801 9.05806 15.7782 9.95993 14.6401 9.95993H4.68011C4.14011 9.95993 3.72011 9.53993 3.72011 8.99993C3.72011 8.45993 4.14011 8.03993 4.68011 8.03993H9.00011C9.12855 8.04181 9.2523 7.99212 9.34417 7.90212C9.43511 7.81118 9.48667 7.68837 9.48667 7.55993C9.48667 7.43148 9.43511 7.30867 9.34417 7.21773C9.2523 7.12773 9.12855 7.07805 9.00011 7.07992H4.68011C3.62449 7.07992 2.76011 7.94431 2.76011 8.99992C2.76011 10.0555 3.62449 10.9199 4.68011 10.9199H14.6401C16.2939 10.9199 17.6401 9.57367 17.6401 7.91992C17.6401 6.26618 16.2939 4.91992 14.6401 4.91992L4.44011 4.91994Z" fill="black"/>
                                </svg>                            
                            </div>
                            <div style="color: #212429; font-size: 14px; font-family: Lato; font-weight: 400; line-height: 20px; letter-spacing: 0.20px; word-wrap: break-word">${el?.name}</div>
                        </div>
                    </div>`;
    })
    .join("");

  $("#com-dash-detail-view-cc").html(ccElement);
  $("#com-dash-detail-view-body").html(
    new DOMParser().parseFromString(data.email_body, "text/html").body
  );

  if (attachmentElement) {
    $("#attachments-container").html(attachmentElement);
    $(".email-attachment-click").on("click", function () {
      let data = $(this).attr("data-attachment");
      console.log("attachment file deatils", JSON.parse(data));
      window.open(JSON.parse(data).file, "_blank");
    });
  } else {
    $("#attachments-container").remove();
  }
}

$("#close-email-detail-view").on("click", function () {
  emailOffcanvas.hide();
});

// $("#com-pkg-email-received-table tbody").append

function debounce(func, timeout = 1000) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      func.apply(this, args);
    }, timeout);
  };
}

function showTableLoader(processing) {
  if (processing) {
    $(document).find(".overlay-spinner").show();
  } else {
    $(document).find(".overlay-spinner").hide();
  }
}
const onTableProcessing = debounce((processing) => showTableLoader(processing));

let emailReceivedTable = $("#com-pkg-email-received-table")
  .on("processing.dt", function (e, settings, processing) {
    $(document).find(".overlay-spinner").hide();
    onTableProcessing(processing);
  })
  .DataTable({
    responsive: true,
    ordering: false,
    info: false,
    paging: true,
    pagingType: "input",
    scrollX: true,
    processing: true,
    serverSide: true,
    order: [],
    language: {
      info: "Showing: _START_-_END_/_TOTAL_ entries",
      lengthMenu:
        'Counts per page <select class="custom-table-page-count">' +
        '<option value="10">10</option>' +
        '<option value="25">25</option>' +
        '<option value="50">50</option>' +
        '<option value="100">100</option>' +
        "</select>",
      paginate: {
        first: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.84362 0.919211C8.05213 0.708929 8.05213 0.367994 7.84362 0.157712C7.63512 -0.0525706 7.29708 -0.0525706 7.08858 0.157712L3.65638 3.61925C3.63031 3.64553 3.60751 3.67386 3.58796 3.70372C3.45113 3.91272 3.47394 4.19675 3.65638 4.38075L7.08858 7.84229C7.29708 8.05257 7.63512 8.05257 7.84362 7.84229C8.05213 7.63201 8.05213 7.29107 7.84362 7.08079L4.78894 4L7.84362 0.919211Z" fill="#1C1E27"/>
                </svg>
                `,
        last: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.65638 0.919211C3.44787 0.708929 3.44787 0.367994 3.65638 0.157712C3.86488 -0.0525706 4.20292 -0.0525706 4.41142 0.157712L7.84362 3.61925C7.86969 3.64553 7.89249 3.67386 7.91204 3.70372C8.04887 3.91272 8.02606 4.19675 7.84362 4.38075L4.41142 7.84229C4.20292 8.05257 3.86488 8.05257 3.65638 7.84229C3.44787 7.63201 3.44787 7.29107 3.65638 7.08079L6.71106 4L3.65638 0.919211Z" fill="#1C1E27"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.156375 0.919211C-0.0521251 0.708929 -0.0521251 0.367994 0.156375 0.157712C0.364875 -0.0525706 0.702921 -0.0525706 0.911421 0.157712L4.34362 3.61925C4.36969 3.64553 4.39249 3.67386 4.41204 3.70372C4.54887 3.91272 4.52606 4.19675 4.34362 4.38075L0.911421 7.84229C0.702921 8.05257 0.364875 8.05257 0.156375 7.84229C-0.0521251 7.63201 -0.0521251 7.29107 0.156375 7.08079L3.21106 4L0.156375 0.919211Z" fill="#1C1E27"/>
                </svg>
                `,
        next: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.656375 0.919211C0.447875 0.708929 0.447875 0.367994 0.656375 0.157712C0.864875 -0.0525706 1.20292 -0.0525706 1.41142 0.157712L4.84362 3.61925C4.86969 3.64553 4.89249 3.67386 4.91204 3.70372C5.04887 3.91272 5.02606 4.19675 4.84362 4.38075L1.41142 7.84229C1.20292 8.05257 0.864875 8.05257 0.656375 7.84229C0.447875 7.63201 0.447875 7.29107 0.656375 7.08079L3.71106 4L0.656375 0.919211Z" fill="#1C1E27"/>
                </svg>`,
        previous: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                </svg>`,
      },
      processing: `<span class="overlay-spinner"></span>`,
    },
    columns: [
      { data: "id", title: "ID" },
      { data: "from_email", title: "From" },
      { data: "subject", title: "Subject" },
      { data: "email_body", title: "Email Body" },
      { data: "status", title: "Status" },
      { data: "timestamp", title: "Date" },
    ],
    createdRow: function (row, data) {
      $(row).css("font-size", "14px");
      $(row).css("font-weight", "400");
      $(row).css("border-bottom", "1px solid #F0F3F4");
      $(row).css("padding", "14px 40px");
      $(row).css("height", "40px");
      $(row).css("cursor", "pointer");
      if (data.isSeen) {
        $(row).css("font-weight", "bold"); // Apply bold style to the first column
      }
      //
      $("td", row).eq(0).css("max-width", "100px");
    },

    ajax: function (d, callback) {
      console.log("received mail table data", d);
      function flattenObject(obj, parentKey = "") {
        let result = {};
        // console.log("flattenObject", obj)
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            let fullKey = parentKey ? `${parentKey}[${key}]` : key;
            if (typeof obj[key] === "object") {
              Object.assign(result, flattenObject(obj[key], fullKey));
            } else {
              result[fullKey] = obj[key];
            }
          }
        }

        return result;
      }
      const flattenedObject = flattenObject({
        ...d,
        search: d.search.value,
      });

      dataTableApiQueries = flattenedObject;

      fetch(
        `${baseUrl}/api/?action=fetch_all_received&${new URLSearchParams(flattenedObject)}`
      )
        .then((response) => response.json())
        .then((data) => {
          console.log(
            "print sent table response data",
            data.response.records,
            data.response.records?.length
          );
          $("#unread-received-count").text(data.response.records?.length);
          let newData = {
            data: data.response.records,
            recordsFiltered: data?.response?.total_records,
            recordsTotal: data?.response?.total_records,
          };
          callback(newData);
        });
    },

    dom: '<"table-top" ><"table-search-box-email-received table-search-box">t<"table-bottom" <"table-info" i> <"table-pagination-box" l<"table-pagination-box-divider">p> >',
    initComplete: function () {
      let totalColumns = this.api().columns().count();
      emailReceivedTable.columns.adjust().draw();
      $(".table-search-box-email-received").html(`
                <div class="table-search-input-box com-pkg-search-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <g clip-path="url(#clip0_2358_618)">
                        <path d="M13.9647 13.0221C15.0263 11.7505 15.6646 10.1148 15.6646 8.33314C15.6646 4.28923 12.375 1 8.33388 1C4.28957 1 1 4.28923 1 8.33314C1 12.3762 4.28957 15.6663 8.33388 15.6663C10.1158 15.6663 11.7516 15.0265 13.0233 13.9666L17.8612 18.8039C17.9909 18.9336 18.1612 19 18.333 19C18.5033 19 18.6752 18.9344 18.8049 18.8039C19.065 18.5438 19.065 18.122 18.8049 17.8619L13.9647 13.0221ZM8.33388 14.3321C5.02631 14.3321 2.33431 11.6403 2.33431 8.3331C2.33431 5.02587 5.02631 2.33413 8.33388 2.33413C11.6414 2.33413 14.3335 5.02587 14.3335 8.3331C14.3335 11.6403 11.6414 14.3321 8.33388 14.3321Z" fill="black" stroke="black" stroke-width="0.2"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_2358_618">
                        <rect width="20" height="20" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                    <input id='email_received_table_search' type="text" placeholder="Search"/>
                </div>
                ${
                  has_export_perm == "true"
                    ? `<div class="table-static-action">
                        <button type="button" class="download-button">
                            <span>Download</span>
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.408 12.9034C18.7349 12.9034 19 13.1658 19 13.4895V15.6002C19 17.4776 17.4623 19 15.566 19H4.43404C2.53774 19 1 17.4776 1 15.6002V13.4895C1 13.1658 1.26509 12.9034 1.59204 12.9034C1.91899 12.9034 2.18408 13.1658 2.18408 13.4895V15.6002C2.18408 16.8302 3.19166 17.8278 4.43408 17.8278H15.566C16.8084 17.8278 17.816 16.8302 17.816 15.6002V13.4895C17.816 13.1658 18.081 12.9034 18.408 12.9034ZM9.99998 2.00008C10.3136 2.00008 10.5709 2.24164 10.5906 2.54723L10.592 2.58621V12.2574L13.1485 9.89548C13.3771 9.68386 13.73 9.68664 13.9557 9.89409L13.9853 9.92402C14.199 10.1503 14.1962 10.4997 13.9867 10.7232L13.9564 10.7524L10.4077 14.0317C10.3965 14.0422 10.3859 14.0512 10.3747 14.061C10.3712 14.0631 10.3684 14.0658 10.3656 14.0679C10.3585 14.0735 10.3508 14.0791 10.3438 14.0839C10.3388 14.0874 10.3339 14.0909 10.3283 14.0944C10.3234 14.0979 10.3184 14.1013 10.3128 14.1041C10.3079 14.1076 10.303 14.1104 10.2973 14.1139C10.2896 14.1181 10.2819 14.1222 10.2734 14.1264L10.2643 14.1313C10.2573 14.1348 10.2495 14.1382 10.2425 14.1417C10.2369 14.1438 10.232 14.1459 10.227 14.148C10.22 14.1508 10.2137 14.1536 10.2073 14.1563L10.1898 14.1619C10.1848 14.164 10.1799 14.1654 10.1743 14.1668C10.1673 14.1689 10.1602 14.171 10.1525 14.173C10.1335 14.1786 10.1131 14.1828 10.0934 14.1856C10.0885 14.1863 10.0829 14.187 10.078 14.1877L10.0386 14.1918L9.99993 14.1925C9.9697 14.1925 9.93946 14.1904 9.90923 14.1863L9.88181 14.1814C9.7004 14.2176 9.50492 14.1696 9.35939 14.0352L5.80655 10.7523C5.56749 10.5316 5.55484 10.1606 5.77772 9.92395C6.00062 9.68727 6.37538 9.67474 6.61443 9.89541L9.40803 12.4765V2.58614C9.40803 2.26244 9.67303 2.00008 9.99998 2.00008Z" fill="black" stroke="black" stroke-width="0.3"/>
                            </svg>
                        </button>
                        <div class="download-confirm-dialog">
                            <div class="download-confirm-dialog-outer">
                                <div class="download-confirm-dialog-messages">
                                    <p>
                                        The report will be available in <strong>‘My Downloads’</strong> in <strong>30 min</strong>.
                                    </p>
                                    <p>
                                        Confirm if you want to proceed with download?
                                    </p>
                                </div> 
                                <button type="button" class="download-confirm-dialog-button">
                                    Download
                                </button>   
                            </div>
                        </div>
                    </div>`
                    : ""
                }
            `);
      function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, timeout);
        };
      }

      function searchInTable(value) {
        emailReceivedTable.search(value).draw();
      }
      const searchFieldChange = debounce((value) => searchInTable(value), 500);

      $(document)
        .find("#email_received_table_search")
        .on("change keyup paste", function () {
          let searchValue = $(this).val();
          console.log("print value search sms", searchValue);
          searchFieldChange(searchValue);
        });

      new $.fn.dataTable.FixedHeader(emailReceivedTable, {
        headerOffset: $(".table-search-box-email-received").outerHeight(),
        header: true,
        footer: false,
      });

      function resizePaginationInputWidth() {
        let value = $(document).find(".paginate_input").val();
        if (value) {
          $(document)
            .find(".paginate_input")
            .css({ width: `${value.length + 5}ch` });
        }
      }

      resizePaginationInputWidth();

      $(document)
        .find(".paginate_input")
        .on("change keypress", function () {
          resizePaginationInputWidth();
        });

      // $("th.each-cell").each((index, cell) => {
      //     if ($(cell).children().length === 0) {
      //         // if column header has more than 70 char then break the line
      //         let cellData = $(cell).html()
      //         let cellDataLength = cellData?.length
      //         if (cellData && cellDataLength > 70) {
      //             $(cell).css("white-space", "break-spaces")
      //         }
      //     }

      // })
    },
  });

emailReceivedTable.on("click", "tbody tr", function () {
  let data = emailReceivedTable.row(this).data();
  console.log("detail view data", data);
  if (data !== undefined) {
    handleEmailDetailView(data);
  }
  console.log("click", data);
});

let emailSentTable = $("#com-pkg-email-sent-table")
  .on("processing.dt", function (e, settings, processing) {
    $(document).find(".overlay-spinner").hide();
    onTableProcessing(processing);
  })
  .DataTable({
    responsive: true,
    ordering: false,
    info: false,
    paging: true,
    pagingType: "input",
    scrollX: true,
    processing: true,
    serverSide: true,
    order: [],
    language: {
      info: "Showing: _START_-_END_/_TOTAL_ entries",
      lengthMenu:
        'Counts per page <select class="custom-table-page-count">' +
        '<option value="10">10</option>' +
        '<option value="25">25</option>' +
        '<option value="50">50</option>' +
        '<option value="100">100</option>' +
        "</select>",
      paginate: {
        first: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.84362 0.919211C8.05213 0.708929 8.05213 0.367994 7.84362 0.157712C7.63512 -0.0525706 7.29708 -0.0525706 7.08858 0.157712L3.65638 3.61925C3.63031 3.64553 3.60751 3.67386 3.58796 3.70372C3.45113 3.91272 3.47394 4.19675 3.65638 4.38075L7.08858 7.84229C7.29708 8.05257 7.63512 8.05257 7.84362 7.84229C8.05213 7.63201 8.05213 7.29107 7.84362 7.08079L4.78894 4L7.84362 0.919211Z" fill="#1C1E27"/>
                </svg>
                `,
        last: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.65638 0.919211C3.44787 0.708929 3.44787 0.367994 3.65638 0.157712C3.86488 -0.0525706 4.20292 -0.0525706 4.41142 0.157712L7.84362 3.61925C7.86969 3.64553 7.89249 3.67386 7.91204 3.70372C8.04887 3.91272 8.02606 4.19675 7.84362 4.38075L4.41142 7.84229C4.20292 8.05257 3.86488 8.05257 3.65638 7.84229C3.44787 7.63201 3.44787 7.29107 3.65638 7.08079L6.71106 4L3.65638 0.919211Z" fill="#1C1E27"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.156375 0.919211C-0.0521251 0.708929 -0.0521251 0.367994 0.156375 0.157712C0.364875 -0.0525706 0.702921 -0.0525706 0.911421 0.157712L4.34362 3.61925C4.36969 3.64553 4.39249 3.67386 4.41204 3.70372C4.54887 3.91272 4.52606 4.19675 4.34362 4.38075L0.911421 7.84229C0.702921 8.05257 0.364875 8.05257 0.156375 7.84229C-0.0521251 7.63201 -0.0521251 7.29107 0.156375 7.08079L3.21106 4L0.156375 0.919211Z" fill="#1C1E27"/>
                </svg>
                `,
        next: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0.656375 0.919211C0.447875 0.708929 0.447875 0.367994 0.656375 0.157712C0.864875 -0.0525706 1.20292 -0.0525706 1.41142 0.157712L4.84362 3.61925C4.86969 3.64553 4.89249 3.67386 4.91204 3.70372C5.04887 3.91272 5.02606 4.19675 4.84362 4.38075L1.41142 7.84229C1.20292 8.05257 0.864875 8.05257 0.656375 7.84229C0.447875 7.63201 0.447875 7.29107 0.656375 7.08079L3.71106 4L0.656375 0.919211Z" fill="#1C1E27"/>
                </svg>`,
        previous: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                </svg>`,
      },
      processing: `<span class="overlay-spinner"></span>`,
    },
    columns: [
      { data: "id", title: "ID" },
      { data: "to_email", title: "To" },
      { data: "subject", title: "Subject" },
      { data: "email_body", title: "Email Body" },
      { data: "status", title: "Status" },
      { data: "timestamp", title: "Date" },
    ],
    columnDefs: [
      {
        targets: 3, // Index of the column to format (0-based index)
        render: function (data, type, row) {
          const decodedContent = new DOMParser().parseFromString(
            data,
            "text/html"
          ).body.textContent;
          // Example: Format age by appending " years" to the value
          // console.log("decodedContent", decodedContent);
          if (String(decodedContent) && String(decodedContent).length > 70) {
            $("td", row).css("white-space", "break-spaces");
          }

          let formattedContent = `<div class="email-test-body" style="display: inline-flex; margin-right: 2px">
                        ${decodedContent}
                        </div>`;

          // console.log("formattedContent", $(formattedContent));

          function cutKeepingTags(elem, reqCount) {
            var grabText = "",
              missCount = reqCount;
            $(elem)
              .contents()
              .each(function () {
                switch (this.nodeType) {
                  case Node.TEXT_NODE:
                    // Get node text, limited to missCount.
                    grabText += this.data.substr(0, missCount);
                    missCount -= Math.min(this.data.length, missCount);
                    break;
                  case Node.ELEMENT_NODE:
                    // Explore current child:
                    var childPart = cutKeepingTags(this, missCount);
                    grabText += childPart.text;
                    missCount -= childPart.count;
                    break;
                }
                if (missCount == 0) {
                  // We got text enough, stop looping.
                  return false;
                }
              });
            return {
              text:
                // Wrap text using current elem tag.
                elem.outerHTML.match(/^<[^>]+>/m)[0] +
                grabText +
                "</" +
                elem.localName +
                ">",
              count: reqCount - missCount,
            };
          }

          var target = $(formattedContent)[0];

          let tempDiv = document.createElement("div");

          // $(tempDiv).attr("display", "inline-flex");

          $(tempDiv).empty();
          var cut = cutKeepingTags(target, 70);
          $(tempDiv).append(cut.text);

          function compareDivs(div1, div2) {
            const html1 = $(div1).html().trim();
            const html2 = $(div2).html().trim();

            return html1 === html2;
          }

          // console.log(
          //   "tempDiv length",
          //   compareDivs($("div", tempDiv), $(target))
          // );

          function show(html) {
            return html
              .replace(/</g, "&lt;")
              .replace(/\n/g, "¶\n")
              .replace(/ /g, "·");
          }

          // console.log("tempDiv", tempDiv, target);

          if (!compareDivs($("div", tempDiv), $(target))) {
            tempDiv.append("...");
          }

          return tempDiv.innerHTML;
        },
      },
      // Add more columnDefs as needed
    ],
    createdRow: function (row, data) {
      // Access the 'isBold' property in the data
      $(row).css("font-size", "14px");
      $(row).css("font-weight", "400");
      $(row).css("border-bottom", "1px solid #F0F3F4");
      $(row).css("padding", "14px 40px");
      $(row).css("height", "40px");
      $(row).css("cursor", "pointer");

      $("td", row).eq(0).css("max-width", "100px");

      //  $("td", row).each((index, cell) => {

      //     if ($(cell).children().length === 0) {
      //         // if column header has more than 70 char then break the line
      //         console.log("cell from ceated row", cell);
      //         let cellData = $(cell).html()
      //         let cellDataLength = cellData?.length
      //         if (cellData && cellDataLength > 70) {
      //             $(cell).css("white-space", "break-spaces")
      //         }
      //     }
      // })
    },

    ajax: function (d, callback) {
      console.log("sent mail table data", d);
      function flattenObject(obj, parentKey = "") {
        let result = {};
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            let fullKey = parentKey ? `${parentKey}[${key}]` : key;
            if (typeof obj[key] === "object") {
              Object.assign(result, flattenObject(obj[key], fullKey));
            } else {
              result[fullKey] = obj[key];
            }
          }
        }

        return result;
      }
      const flattenedObject = flattenObject({
        ...d,
        search: d.search.value,
      });

      dataTableApiQueries = flattenedObject;

      fetch(
        `${baseUrl}/api/?action=fetch_all_sent&${new URLSearchParams(flattenedObject)}`
      )
        .then((response) => response.json())
        .then((data) => {
          // console.log("print sent table response data", data)
          let newData = {
            data: data.response.records,
            recordsFiltered: data?.response?.total_records,
            recordsTotal: data?.response?.total_records,
          };
          callback(newData);
        });
    },

    dom: '<"table-top" ><"table-search-box-email-sent table-search-box"><"overlay-spinner">t<"table-bottom" <"table-info" i> <"table-pagination-box" l<"table-pagination-box-divider">p> >',
    initComplete: function () {
      let totalColumns = this.api().columns().count();
      emailSentTable.columns.adjust().draw();
      $(".table-search-box-email-sent").html(`
                <div class="table-search-input-box com-pkg-search-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <g clip-path="url(#clip0_2358_618)">
                        <path d="M13.9647 13.0221C15.0263 11.7505 15.6646 10.1148 15.6646 8.33314C15.6646 4.28923 12.375 1 8.33388 1C4.28957 1 1 4.28923 1 8.33314C1 12.3762 4.28957 15.6663 8.33388 15.6663C10.1158 15.6663 11.7516 15.0265 13.0233 13.9666L17.8612 18.8039C17.9909 18.9336 18.1612 19 18.333 19C18.5033 19 18.6752 18.9344 18.8049 18.8039C19.065 18.5438 19.065 18.122 18.8049 17.8619L13.9647 13.0221ZM8.33388 14.3321C5.02631 14.3321 2.33431 11.6403 2.33431 8.3331C2.33431 5.02587 5.02631 2.33413 8.33388 2.33413C11.6414 2.33413 14.3335 5.02587 14.3335 8.3331C14.3335 11.6403 11.6414 14.3321 8.33388 14.3321Z" fill="black" stroke="black" stroke-width="0.2"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_2358_618">
                        <rect width="20" height="20" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                    <input id='email_sent_table_search' type="text" placeholder="Search"/>
                </div>
                 ${
                   has_export_perm == "true"
                     ? `<div class="table-static-action">
                        <button type="button" class="download-button">
                            <span>Download</span>
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.408 12.9034C18.7349 12.9034 19 13.1658 19 13.4895V15.6002C19 17.4776 17.4623 19 15.566 19H4.43404C2.53774 19 1 17.4776 1 15.6002V13.4895C1 13.1658 1.26509 12.9034 1.59204 12.9034C1.91899 12.9034 2.18408 13.1658 2.18408 13.4895V15.6002C2.18408 16.8302 3.19166 17.8278 4.43408 17.8278H15.566C16.8084 17.8278 17.816 16.8302 17.816 15.6002V13.4895C17.816 13.1658 18.081 12.9034 18.408 12.9034ZM9.99998 2.00008C10.3136 2.00008 10.5709 2.24164 10.5906 2.54723L10.592 2.58621V12.2574L13.1485 9.89548C13.3771 9.68386 13.73 9.68664 13.9557 9.89409L13.9853 9.92402C14.199 10.1503 14.1962 10.4997 13.9867 10.7232L13.9564 10.7524L10.4077 14.0317C10.3965 14.0422 10.3859 14.0512 10.3747 14.061C10.3712 14.0631 10.3684 14.0658 10.3656 14.0679C10.3585 14.0735 10.3508 14.0791 10.3438 14.0839C10.3388 14.0874 10.3339 14.0909 10.3283 14.0944C10.3234 14.0979 10.3184 14.1013 10.3128 14.1041C10.3079 14.1076 10.303 14.1104 10.2973 14.1139C10.2896 14.1181 10.2819 14.1222 10.2734 14.1264L10.2643 14.1313C10.2573 14.1348 10.2495 14.1382 10.2425 14.1417C10.2369 14.1438 10.232 14.1459 10.227 14.148C10.22 14.1508 10.2137 14.1536 10.2073 14.1563L10.1898 14.1619C10.1848 14.164 10.1799 14.1654 10.1743 14.1668C10.1673 14.1689 10.1602 14.171 10.1525 14.173C10.1335 14.1786 10.1131 14.1828 10.0934 14.1856C10.0885 14.1863 10.0829 14.187 10.078 14.1877L10.0386 14.1918L9.99993 14.1925C9.9697 14.1925 9.93946 14.1904 9.90923 14.1863L9.88181 14.1814C9.7004 14.2176 9.50492 14.1696 9.35939 14.0352L5.80655 10.7523C5.56749 10.5316 5.55484 10.1606 5.77772 9.92395C6.00062 9.68727 6.37538 9.67474 6.61443 9.89541L9.40803 12.4765V2.58614C9.40803 2.26244 9.67303 2.00008 9.99998 2.00008Z" fill="black" stroke="black" stroke-width="0.3"/>
                            </svg>
                        </button>
                        <div class="download-confirm-dialog">
                            <div class="download-confirm-dialog-outer">
                                <div class="download-confirm-dialog-messages">
                                    <p>
                                        The report will be available in <strong>‘My Downloads’</strong> in <strong>30 min</strong>.
                                    </p>
                                    <p>
                                        Confirm if you want to proceed with download?
                                    </p>
                                </div> 
                                <button type="button" class="download-confirm-dialog-button">
                                    Download
                                </button>   
                            </div>
                        </div>
                    </div>`
                     : ""
                 }
                
            `);
      function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, timeout);
        };
      }

      function searchInTable(value) {
        emailSentTable.search(value).draw();
      }
      const searchFieldChange = debounce((value) => searchInTable(value), 500);

      $(document)
        .find("#email_sent_table_search")
        .on("change keyup paste", function () {
          let searchValue = $(this).val();
          console.log("print value search sms", searchValue);
          searchFieldChange(searchValue);
        });

      new $.fn.dataTable.FixedHeader(emailSentTable, {
        headerOffset: $(".table-search-box-email-sent").outerHeight(),
        header: true,
        footer: false,
      });

      function resizePaginationInputWidth() {
        let value = $(document).find(".paginate_input").val();
        if (value) {
          $(document)
            .find(".paginate_input")
            .css({ width: `${value.length + 5}ch` });
        }
      }

      resizePaginationInputWidth();

      $(document)
        .find(".paginate_input")
        .on("change keypress", function () {
          resizePaginationInputWidth();
        });

      // $("#com-pkg-email-sent-table tr td").each((index, cell) => {
      //     console.log("print cell", cell);
      //     if ($(cell).children().length === 0) {
      //         // if column header has more than 70 char then break the line
      //         let cellData = $(cell).html()
      //         let cellDataLength = cellData?.length
      //         if (cellData && cellDataLength > 70) {
      //             $(cell).css("white-space", "break-spaces")
      //         }
      //     }

      // })
    },
  });

emailSentTable.on("click", "tbody tr", function () {
  let data = emailSentTable.row(this).data();
  if (data !== undefined) {
    handleEmailDetailView(data);
  }
  console.log("click", data);
});

let emailDraftTable = $("#com-pkg-email-draft-table")
  .on("processing.dt", function (e, settings, processing) {
    $(document).find(".overlay-spinner").hide();
    onTableProcessing(processing);
  })
  .DataTable({
    responsive: true,
    ordering: false,
    info: false,
    paging: true,
    pagingType: "input",
    scrollX: true,
    processing: true,
    serverSide: true,
    order: [],
    language: {
      info: "Showing: _START_-_END_/_TOTAL_ entries",
      lengthMenu:
        'Counts per page <select class="custom-table-page-count">' +
        '<option value="10">10</option>' +
        '<option value="25">25</option>' +
        '<option value="50">50</option>' +
        '<option value="100">100</option>' +
        "</select>",
      paginate: {
        first: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.84362 0.919211C8.05213 0.708929 8.05213 0.367994 7.84362 0.157712C7.63512 -0.0525706 7.29708 -0.0525706 7.08858 0.157712L3.65638 3.61925C3.63031 3.64553 3.60751 3.67386 3.58796 3.70372C3.45113 3.91272 3.47394 4.19675 3.65638 4.38075L7.08858 7.84229C7.29708 8.05257 7.63512 8.05257 7.84362 7.84229C8.05213 7.63201 8.05213 7.29107 7.84362 7.08079L4.78894 4L7.84362 0.919211Z" fill="#1C1E27"/>
                    </svg>
                    `,
        last: `<svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.65638 0.919211C3.44787 0.708929 3.44787 0.367994 3.65638 0.157712C3.86488 -0.0525706 4.20292 -0.0525706 4.41142 0.157712L7.84362 3.61925C7.86969 3.64553 7.89249 3.67386 7.91204 3.70372C8.04887 3.91272 8.02606 4.19675 7.84362 4.38075L4.41142 7.84229C4.20292 8.05257 3.86488 8.05257 3.65638 7.84229C3.44787 7.63201 3.44787 7.29107 3.65638 7.08079L6.71106 4L3.65638 0.919211Z" fill="#1C1E27"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0.156375 0.919211C-0.0521251 0.708929 -0.0521251 0.367994 0.156375 0.157712C0.364875 -0.0525706 0.702921 -0.0525706 0.911421 0.157712L4.34362 3.61925C4.36969 3.64553 4.39249 3.67386 4.41204 3.70372C4.54887 3.91272 4.52606 4.19675 4.34362 4.38075L0.911421 7.84229C0.702921 8.05257 0.364875 8.05257 0.156375 7.84229C-0.0521251 7.63201 -0.0521251 7.29107 0.156375 7.08079L3.21106 4L0.156375 0.919211Z" fill="#1C1E27"/>
                    </svg>
                    `,
        next: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0.656375 0.919211C0.447875 0.708929 0.447875 0.367994 0.656375 0.157712C0.864875 -0.0525706 1.20292 -0.0525706 1.41142 0.157712L4.84362 3.61925C4.86969 3.64553 4.89249 3.67386 4.91204 3.70372C5.04887 3.91272 5.02606 4.19675 4.84362 4.38075L1.41142 7.84229C1.20292 8.05257 0.864875 8.05257 0.656375 7.84229C0.447875 7.63201 0.447875 7.29107 0.656375 7.08079L3.71106 4L0.656375 0.919211Z" fill="#1C1E27"/>
                    </svg>`,
        previous: `<svg xmlns="http://www.w3.org/2000/svg" width="5" height="8" viewBox="0 0 5 8" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.34362 0.919211C4.55213 0.708929 4.55213 0.367994 4.34362 0.157712C4.13512 -0.0525706 3.79708 -0.0525706 3.58858 0.157712L0.156375 3.61925C0.130313 3.64553 0.107508 3.67386 0.0879612 3.70372C-0.0488672 3.91272 -0.0260625 4.19675 0.156375 4.38075L3.58858 7.84229C3.79708 8.05257 4.13512 8.05257 4.34362 7.84229C4.55213 7.63201 4.55213 7.29107 4.34362 7.08079L1.28894 4L4.34362 0.919211Z" fill="#1C1E27"/>
                    </svg>`,
      },
      processing: `<span class="overlay-spinner"></span>`,
    },
    columns: [
      { data: "id", title: "ID" },
      { data: "to_email", title: "To" },
      { data: "subject", title: "Subject" },
      { data: "email_body", title: "Email Body" },
      { data: "status", title: "Status" },
      { data: "timestamp", title: "Date" },
    ],
    columnDefs: [
      {
        targets: 4, // Index of the column to format (0-based index)
        render: function (data, type, row) {
          const decodedContent = new DOMParser().parseFromString(
            data,
            "text/html"
          ).body.textContent;

          // Example: Format age by appending " years" to the value
          return decodedContent;
        },
      },
      // Add more columnDefs as needed
    ],
    createdRow: function (row, data) {
      // Access the 'isBold' property in the data
      $(row).css("font-size", "14px");
      $(row).css("font-weight", "400");
      $(row).css("border-bottom", "1px solid #F0F3F4");
      $(row).css("padding", "12px 16px 12px 40px");
      $(row).css("height", "40px");
      $(row).css("cursor", "pointer");

      $("td", row).eq(0).css("max-width", "100px");
    },
    ajax: function (d, callback) {
      console.log("draft mail data", d);

      function flattenObject(obj, parentKey = "") {
        let result = {};
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            let fullKey = parentKey ? `${parentKey}[${key}]` : key;
            if (typeof obj[key] === "object") {
              Object.assign(result, flattenObject(obj[key], fullKey));
            } else {
              result[fullKey] = obj[key];
            }
          }
        }

        return result;
      }
      const flattenedObject = flattenObject({
        ...d,
        search: d.search.value,
      });

      dataTableApiQueries = flattenedObject;

      fetch(
        `${baseUrl}/api/?action=fetch_all_drafts&${new URLSearchParams(flattenedObject)}`
      )
        .then((response) => response.json())
        .then((data) => {
          $("#draft-count").text(data.response.total_records);
          let newData = {
            data: data.response.records,
            recordsFiltered: data?.response?.total_records,
            recordsTotal: data?.response?.total_records,
          };
          callback(newData);
        });
    },
    dom: '<"table-top" ><"table-search-box-email-draft table-search-box">t<"table-bottom" <"table-info" i> <"table-pagination-box" l<"table-pagination-box-divider">p> >',
    initComplete: function () {
      let totalColumns = this.api().columns().count();
      emailDraftTable.columns.adjust().draw();
      $(".table-search-box-email-draft").html(`
                    <div class="table-search-input-box com-pkg-search-box">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <g clip-path="url(#clip0_2358_618)">
                            <path d="M13.9647 13.0221C15.0263 11.7505 15.6646 10.1148 15.6646 8.33314C15.6646 4.28923 12.375 1 8.33388 1C4.28957 1 1 4.28923 1 8.33314C1 12.3762 4.28957 15.6663 8.33388 15.6663C10.1158 15.6663 11.7516 15.0265 13.0233 13.9666L17.8612 18.8039C17.9909 18.9336 18.1612 19 18.333 19C18.5033 19 18.6752 18.9344 18.8049 18.8039C19.065 18.5438 19.065 18.122 18.8049 17.8619L13.9647 13.0221ZM8.33388 14.3321C5.02631 14.3321 2.33431 11.6403 2.33431 8.3331C2.33431 5.02587 5.02631 2.33413 8.33388 2.33413C11.6414 2.33413 14.3335 5.02587 14.3335 8.3331C14.3335 11.6403 11.6414 14.3321 8.33388 14.3321Z" fill="black" stroke="black" stroke-width="0.2"/>
                            </g>
                            <defs>
                            <clipPath id="clip0_2358_618">
                            <rect width="20" height="20" fill="white"/>
                            </clipPath>
                            </defs>
                        </svg>
                        <input id='email_draft_table_search' type="text" placeholder="Search"/>
                    </div>
                    ${
                      has_export_perm == "true"
                        ? `<div class="table-static-action">
                            <button type="button" class="download-button">
                                <span>Download</span>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18.408 12.9034C18.7349 12.9034 19 13.1658 19 13.4895V15.6002C19 17.4776 17.4623 19 15.566 19H4.43404C2.53774 19 1 17.4776 1 15.6002V13.4895C1 13.1658 1.26509 12.9034 1.59204 12.9034C1.91899 12.9034 2.18408 13.1658 2.18408 13.4895V15.6002C2.18408 16.8302 3.19166 17.8278 4.43408 17.8278H15.566C16.8084 17.8278 17.816 16.8302 17.816 15.6002V13.4895C17.816 13.1658 18.081 12.9034 18.408 12.9034ZM9.99998 2.00008C10.3136 2.00008 10.5709 2.24164 10.5906 2.54723L10.592 2.58621V12.2574L13.1485 9.89548C13.3771 9.68386 13.73 9.68664 13.9557 9.89409L13.9853 9.92402C14.199 10.1503 14.1962 10.4997 13.9867 10.7232L13.9564 10.7524L10.4077 14.0317C10.3965 14.0422 10.3859 14.0512 10.3747 14.061C10.3712 14.0631 10.3684 14.0658 10.3656 14.0679C10.3585 14.0735 10.3508 14.0791 10.3438 14.0839C10.3388 14.0874 10.3339 14.0909 10.3283 14.0944C10.3234 14.0979 10.3184 14.1013 10.3128 14.1041C10.3079 14.1076 10.303 14.1104 10.2973 14.1139C10.2896 14.1181 10.2819 14.1222 10.2734 14.1264L10.2643 14.1313C10.2573 14.1348 10.2495 14.1382 10.2425 14.1417C10.2369 14.1438 10.232 14.1459 10.227 14.148C10.22 14.1508 10.2137 14.1536 10.2073 14.1563L10.1898 14.1619C10.1848 14.164 10.1799 14.1654 10.1743 14.1668C10.1673 14.1689 10.1602 14.171 10.1525 14.173C10.1335 14.1786 10.1131 14.1828 10.0934 14.1856C10.0885 14.1863 10.0829 14.187 10.078 14.1877L10.0386 14.1918L9.99993 14.1925C9.9697 14.1925 9.93946 14.1904 9.90923 14.1863L9.88181 14.1814C9.7004 14.2176 9.50492 14.1696 9.35939 14.0352L5.80655 10.7523C5.56749 10.5316 5.55484 10.1606 5.77772 9.92395C6.00062 9.68727 6.37538 9.67474 6.61443 9.89541L9.40803 12.4765V2.58614C9.40803 2.26244 9.67303 2.00008 9.99998 2.00008Z" fill="black" stroke="black" stroke-width="0.3"/>
                                </svg>
                            </button>
                            <div class="download-confirm-dialog">
                                <div class="download-confirm-dialog-outer">
                                    <div class="download-confirm-dialog-messages">
                                        <p>
                                            The report will be available in <strong>‘My Downloads’</strong> in <strong>30 min</strong>.
                                        </p>
                                        <p>
                                            Confirm if you want to proceed with download?
                                        </p>
                                    </div> 
                                    <button type="button" class="download-confirm-dialog-button">
                                        Download
                                    </button>   
                                </div>
                            </div>
                        </div>`
                        : ""
                    }
                `);
      function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, timeout);
        };
      }

      function searchInTable(value) {
        emailDraftTable.search(value).draw();
      }
      const searchFieldChange = debounce((value) => searchInTable(value), 500);

      $(document)
        .find("#email_draft_table_search")
        .on("change keyup paste", function () {
          let searchValue = $(this).val();
          console.log("print value search sms", searchValue);
          searchFieldChange(searchValue);
        });

      new $.fn.dataTable.FixedHeader(emailDraftTable, {
        headerOffset: $(".table-search-box-email-draft").outerHeight(),
        header: true,
        footer: false,
      });

      function resizePaginationInputWidth() {
        let value = $(document).find(".paginate_input").val();
        if (value) {
          $(document)
            .find(".paginate_input")
            .css({ width: `${value.length + 5}ch` });
        }
      }

      resizePaginationInputWidth();

      $(document)
        .find(".paginate_input")
        .on("change keypress", function () {
          resizePaginationInputWidth();
        });

      $(".each-cell").each((index, cell) => {
        console.log("print cell", cell);
        if ($(cell).children().length === 0) {
          // if column header has more than 70 char then break the line
          let cellData = $(cell).html();
          let cellDataLength = cellData?.length;
          if (cellData && cellDataLength > 70) {
            $(cell).css("white-space", "break-spaces");
          }
        }
      });
    },
  });

async function sendOrDraftEmail(url, reqType) {
  $(document).find(".overlay-spinner").show();

  let formData = new FormData();
  formData.append("to", $("#root_to").val());

  var ccEmails = $("#root_cc").val();

  function getEmailArray(emails) {
    // If there are no commas in the string, add the entire string as a single email
    if (!emails.includes(",")) {
      return [emails.trim()];
    }

    return emails.split(",").map((email) => email.trim());
  }

  console.log("email array", getEmailArray(ccEmails));

  formData.append("cc", getEmailArray(ccEmails));
  formData.append("subject", $("#root_subject").val());
  formData.append("body", $(".ql-editor").html());

  var files = $("#root_attatchments")[0].files;
  console.log("file list", files, attatchmentsList);
  if (files.length > 0) {
    for (let i = 0; i < files.length; i++) {
      formData.append("attachments", files[i]);
    }
  }

  if (attatchmentsList?.length > 0) {
    attatchmentsList.forEach((el) => formData.append("attachments", el.pk));
  }

  for (var pair of formData.entries()) {
    console.log(pair[0] + ", " + pair[1]);
  }

  console.log("file form list", formData);

  function getCookie(cname) {
    let name = cname + "=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(";");
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) == " ") {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
  }

  await fetch(url, {
    method: reqType || "POST",
    headers: {
      "X-CSRFToken": csrf_token,
      zangocookie: getCookie("zangocookie"),
    },
    body: formData,
  })
    .then((response) => response.json())
    .then((responseData) => {
      $(document).find(".overlay-spinner").hide();
      if (responseData?.success) {
        window.location.reload();
        console.log("fetched drafts here", responseData);
      } else {
      }
    })
    .catch((error) => {
      $(document).find(".overlay-spinner").hide();
      ZToast("error", "Server Error", error?.message, 3000);
      throw error;
    });
  $(document).find(".overlay-spinner").hide();
}

$("#com-pkg-save-draft").on("click", async function (event) {
  event.preventDefault();
  console.log("save draft", draftDrawerOpen);
  if (!draftDrawerOpen) {
    let url = `${window.location.origin}/communication/email/api/?action=draft`;
    let reqType = "POST";
    if (opendDraftMail) {
      reqType = "PUT";
      url = `${window.location.origin}/communication/email/api/?action=update_draft&pk=${opendDraftMail}`;
    }

    // Perform validation
    if (!$("#root_to").val()) {
      return;
    } else {
      await sendOrDraftEmail(url, reqType);
    }
  }
});

// $("#com-pkg-send-email").on("click", async function (event) {
//   event.preventDefault();

//   let url = `${window.location.origin}/communication/email/api/?action=send`;

//   if (opendDraftMail) {
//     url = `${window.location.origin}/communication/email/api/?action=send&draft=true&pk=${opendDraftMail}`;
//   }

//   $(document).find(".overlay-spinner").show();

//   if (!validateForm()) {

//   } else {
//     await sendOrDraftEmail(url);
//   }
// });

$("#compose-btn").on("click", async function (event) {
  //   $(".zelthy-dynamic-form").html("");
  console.log("compose button clicked here");
  opendDraftMail = null;
  draftDrawerOpen = false;
  $("#com-pkg-email-validation").hide();
  $("#com-pkg-email-cc-validation").hide();
  $("#com-pkg-compose-email-cc").val("");
  $("#com-pkg-compose-email-to").val("");
  $("#com-pkg-compose-email-subject").val("");

  ZelthyRJSF(".zelthy-dynamic-form", {
    get_data: {
      is_api_based: false,
      static_config: {
        form: {
          json_schema: {
            title: "Compose email",
            type: "object",
            properties: {
              to: {
                title: "To",
                type: "string",
              },
              cc: {
                title: "CC",
                type: "string",
              },
              subject: {
                title: "Subject",
                type: "string",
              },
              body: {
                title: "Message",
                type: "string",
              },
              attatchments: {
                title: "Attatchments",
                type: "string",
              },
            },
            required: ["to", "subject", "body"],
          },
          ui_schema: {
            to: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "To email is required",
              },
              "ui:widget": "EmailFieldWidget",
            },
            cc: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              // "ui:errorMessages": {
              //   required: "CC email is required",
              // },
              "ui:widget": "EmailFieldWidget",
            },
            subject: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "Subject is required",
              },
              "ui:widget": "TextFieldWidget",
            },
            body: {
              "ui:placeholder": "Enter your Message",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "Message is required",
              },
              "ui:widget": "RichTextEditorWidget",
              "ui:modules": {
                toolbar: [
                  [{ header: [1, 2, false] }],
                  ["bold", "italic", "underline", "strike", "blockquote"],
                  [
                    { list: "ordered" },
                    { list: "bullet" },
                    { indent: "-1" },
                    { indent: "+1" },
                  ],
                  ["link", "image"],
                  ["clean"],
                ],
              },
              "ui:formats": [
                "header",
                "bold",
                "italic",
                "underline",
                "strike",
                "blockquote",
                "list",
                "bullet",
                "indent",
                "link",
                "image",
              ],
            },
            attatchments: {
              "ui:placeholder": "Upload attatchments",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {},
              "ui:widget": "FileFieldWidget",
              "ui:format": "data-url",
            },
            "ui:submitButtonOptions": {
              submitText: "Send Email",
            },
          },
        },
      },
    },
    post_data: {
      http_method: "POST",
      url: `${window.location.origin}/communication/email/api/?action=send`,
      payload_type: "FORMDATA",
    },
  });

  if (quill) {
    quill.setContents([{ insert: "" }]);
  }

  $("#attachments-list").text("");
});

emailDraftTable.on("click", "tbody tr", function () {
  let data = emailDraftTable.row(this).data();
  handleDraftMail(data);
  console.log("click", data);
});

function handleDraftMail(data) {
  draftDrawerOpen = true;

  //   $("#com-pkg-compose-email-to").val(data.to_email);
  //   $("#com-pkg-compose-email-subject").val(data.subject);

  //   const decodedContent = new DOMParser().parseFromString(
  //     data.email_body,
  //     "text/html"
  //   ).body.textContent;

  //   if (quill) {
  //     quill.clipboard.dangerouslyPasteHTML(decodedContent);
  //   }

  //   $("#attachments-list").text(
  //     data?.attachments?.map((el) => el.name)?.toString()
  //   );

  opendDraftMail = data.pk;
  attatchmentsList = data.attachments;
  console.log(
    "draft Row Clicked:",
    // $(".zelthy-dynamic-draft-form").html(),
    data
  );

  ZelthyRJSF(".zelthy-dynamic-form", {
    get_data: {
      is_api_based: false,
      static_config: {
        form: {
          json_schema: {
            title: "Compose email",
            type: "object",
            properties: {
              to: {
                title: "To",
                type: "string",
                default: data.to_email.map((el) => el).join(","),
              },
              cc: {
                title: "CC",
                type: "string",
                default: data.cc_email.map((el) => el).join(","),
              },
              subject: {
                title: "Subject",
                type: "string",
                default: data.subject,
              },
              body: {
                title: "Message",
                type: "string",
                default: data.email_body,
              },
              attatchments: {
                title: "Attatchments",
                type: "string",
                default: data?.attachments?.map((el) => el.name)?.toString(),
              },
            },
            required: ["to", "subject", "body"],
          },
          ui_schema: {
            to: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "To email is required",
              },
              "ui:widget": "EmailFieldWidget",
            },
            cc: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              // "ui:errorMessages": {
              //   required: "CC email is required",
              // },
              "ui:widget": "EmailFieldWidget",
            },
            subject: {
              "ui:placeholder": "Enter recipients",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "Subject is required",
              },
              "ui:widget": "TextFieldWidget",
            },
            body: {
              "ui:placeholder": "Enter your Message",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {
                required: "Message is required",
              },
              "ui:widget": "RichTextEditorWidget",
              "ui:modules": {
                toolbar: [
                  [{ header: [1, 2, false] }],
                  ["bold", "italic", "underline", "strike", "blockquote"],
                  [
                    { list: "ordered" },
                    { list: "bullet" },
                    { indent: "-1" },
                    { indent: "+1" },
                  ],
                  ["link", "image"],
                  ["clean"],
                ],
              },
              "ui:formats": [
                "header",
                "bold",
                "italic",
                "underline",
                "strike",
                "blockquote",
                "list",
                "bullet",
                "indent",
                "link",
                "image",
              ],
            },
            attatchments: {
              "ui:placeholder": "Upload attatchments",
              "ui:syncEnabled": false,
              "ui:autocomplete": {},
              "ui:errorMessages": {},
              "ui:widget": "FileFieldWidget",
              "ui:format": "data-url",
            },
            "ui:submitButtonOptions": {
              submitText: "Send Email",
            },
          },
        },
      },
    },
    post_data: {
      http_method: "POST",
      url: `${window.location.origin}/communication/email/api/?action=send`,
      payload_type: "FORMDATA",
    },
  });
  const mailDrawer = document.getElementById("com-pkg-email-draft-modal");
  var bsOffcanvas = new bootstrap.Offcanvas(mailDrawer);
  bsOffcanvas.show();
}
